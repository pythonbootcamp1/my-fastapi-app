# ==================================================
# 멀티스테이지 보안 최적화 Dockerfile
# 크기: 180MB → 135MB (25% 감소)
# 보안: 비root 사용자 (UID 10000)
# ==================================================

# ==================================================
# Stage 1: Builder - 의존성 설치 단계
# ==================================================
FROM python:3.12 AS builder
# ↑ Full 이미지 사용 (모든 빌드 도구 포함)
# ↑ "builder"라는 이름으로 stage 지정

WORKDIR /app

# 의존성 파일만 먼저 복사 (캐시 최적화)
COPY requirements.txt .

# 가상 환경 생성 및 의존성 설치
RUN python -m venv /opt/venv && \
    /opt/venv/bin/pip install --upgrade pip && \
    /opt/venv/bin/pip install --no-cache-dir -r requirements.txt
# 설명:
# - python -m venv /opt/venv: 가상 환경 생성
# - /opt/venv/bin/pip: 가상 환경의 pip 사용
# - --no-cache-dir: pip 캐시 저장 안 함 (용량 절감)
# - 이 stage는 최종 이미지에 포함되지 않음!

# ==================================================
# Stage 2: Runtime - 최종 실행 이미지
# ==================================================
FROM python:3.12-slim
# ↑ Slim 이미지 사용 (최소 크기)
# ↑ 완전히 새로운 컨테이너 시작!

# ==================================================
# 메타데이터 (LABEL)
# ==================================================
LABEL maintainer="your-email@example.com"
LABEL version="3.0.0"
LABEL description="Production-ready FastAPI with multi-stage build"

# OCI 표준 레이블
LABEL org.opencontainers.image.created="2025-11-05T10:00:00Z"
LABEL org.opencontainers.image.version="3.0.0"
LABEL org.opencontainers.image.title="Optimized FastAPI"
LABEL org.opencontainers.image.description="Multi-stage build with security"

# ==================================================
# 시스템 패키지 설치 (root 권한 필요)
# ==================================================
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        curl \
    && rm -rf /var/lib/apt/lists/*
# 설명:
# - curl: HEALTHCHECK에서 HTTP 요청용
# - --no-install-recommends: 추천 패키지 제외
# - rm -rf /var/lib/apt/lists/*: apt 캐시 삭제 (5MB 절감)

# ==================================================
# 작업 디렉토리
# ==================================================
WORKDIR /app

# ==================================================
# 환경 변수
# ==================================================
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PATH="/opt/venv/bin:$PATH" \
    ENVIRONMENT=production
# 설명:
# - PYTHONDONTWRITEBYTECODE=1: .pyc 파일 생성 안 함
# - PYTHONUNBUFFERED=1: 로그 즉시 출력
# - PATH: 가상 환경 명령어 우선 사용
# - ENVIRONMENT: 프로덕션 환경 표시

# ==================================================
# Stage 1에서 가상 환경 복사 ⭐⭐⭐
# ==================================================
COPY --from=builder /opt/venv /opt/venv
# 핵심 명령어!
# builder stage의 /opt/venv를 현재 stage로 복사
# 복사되는 것: 설치된 패키지만
# 복사되지 않는 것: pip, setuptools, 빌드 도구 등

# ==================================================
# 애플리케이션 코드 복사
# ==================================================
COPY . .
# 설명:
# - app/ 디렉토리만 복사 (불필요한 파일 제외)
# - .dockerignore에서 제외한 파일들은 복사 안 됨

# ==================================================
# 비root 사용자 생성 ⭐⭐⭐
# ==================================================
RUN groupadd -r appuser -g 10000 && \
    useradd -r -u 10000 -g appuser -s /bin/bash appuser && \
    chown -R appuser:appuser /app
# 설명:
# - groupadd: appuser 그룹 (GID: 10000)
# - useradd: appuser 사용자 (UID: 10000)
# - chown: /app 소유권을 appuser로 변경
# - UID/GID 10000 이상 사용 (호스트와 충돌 방지)

# ==================================================
# 사용자 전환 ⭐⭐⭐
# ==================================================
USER appuser
# 이 줄 이후의 모든 명령어는 appuser 권한으로 실행
# CMD도 appuser로 실행됨

# ==================================================
# 포트 문서화
# ==================================================
EXPOSE 8000

# ==================================================
# 헬스체크 ⭐⭐
# ==================================================
HEALTHCHECK --interval=30s \
            --timeout=10s \
            --start-period=10s \
            --retries=3 \
  CMD curl -f http://localhost:8000/health || exit 1
# 설명:
# - --interval=30s: 30초마다 확인
# - --timeout=10s: 응답 대기 10초
# - --start-period=10s: 시작 후 10초 대기
# - --retries=3: 3회 연속 실패 시 unhealthy
# - curl -f: HTTP 에러 시 exit 1

# ==================================================
# 실행 명령어
# ==================================================
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
# appuser 권한으로 실행됨



# Dockerfile.optimized 생성
# 가이드의 내용 복사붙여넣기
# 내용 쭉~ 살펴보기!!!
# 수정 -> app.main:app -> main:app
# add, commit, push
# 2:35 까지 진행하겠습니다!!